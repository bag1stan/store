<div class="cell-dialog" [class.cell-dialog_with-statistic]="expanded()">
  <tui-expand [expanded]="expanded()">
    <ng-template tuiExpandContent>
      <div style="display: flex; flex-direction: column; gap: 16px;">
        <div tuiSurface="outline" class="statistic">
          <div class="statistic__item">
            <h3 style="margin: 0;">Расходы</h3>

            <ng-container *ngTemplateOutlet="chipList, context: { $implicit: sumCostInKzt() }"/>
          </div>
        </div>


        <div tuiSurface="outline" class="statistic">
          <div class="statistic__item">
            <h3 style="margin: 0;">Доходы</h3>

            <div style="display: flex; flex-direction: column; gap: 16px">
              <ng-container *ngTemplateOutlet="chipList, context: { $implicit: sumMyCostInKzt() }"/>

              @if (sumMyCostSellsInKzt(); as sum) {
                <ng-container *ngTemplateOutlet="chipList, context: { $implicit: sum, prefix: '+ ' }"/>
              }
            </div>
          </div>
        </div>

        <div tuiSurface="outline" class="statistic">
          <div class="statistic__item">
            <h3 style="margin: 0;">Прибыль</h3>

            <div style="display: flex; flex-direction: column; gap: 16px">
              <ng-container *ngTemplateOutlet="chipList, context: { $implicit: sumSoldInKzt() }"/>

              @if (sumSellInKzt(); as sum) {
                <ng-container *ngTemplateOutlet="chipList, context: { $implicit: sum, prefix: '+ ' }"/>
              }
            </div>
          </div>
        </div>
      </div>
    </ng-template>
  </tui-expand>

  <tui-scrollbar style="flex-grow: 1">
    <section class="sold-list">
      @for(soldGroup of form.controls; track soldGroup) {
        <form class="sold-item" [formGroup]="soldGroup">
          <tui-chip tuiFade size="m" appearance="secondary" style="flex: 1 1 auto; display: flex; justify-content: space-between">
            <span>{{soldGroup.controls['title'].value}}</span>
            <span>{{soldGroup.controls['amount'].value}} шт.</span>
          </tui-chip>

          <tui-textfield style="min-width: 60px; max-width: fit-content; max-height: var(--tui-height-m);" [tuiTextfieldCleaner]="false">
            <input
              style="text-align: center;"
              tuiInputNumber
              formControlName="sold"
            />
          </tui-textfield>

          <button
            size="m"
            tuiIconButton
            appearance="outline-destructive"
            type="button"
            iconStart="x"
            (click)="deleteOne($index)"
          >
            Удалить продажу
          </button>
        </form>
      }
    </section>
  </tui-scrollbar>

  <div class="actions">
    <tui-select [formControl]="cellItemControl">
      Добавить товар к продаже
      <input
        disabled
        placeholder="Отсортированы как в таблице"
        tuiTextfieldLegacy
      />
      <tui-data-list-wrapper
        *tuiDataList
        emptyContent="Нет товаров в наличии"
        [items]="items() | tuiFilterByInput | sortById | filterWithAmount | filterByAddedSell : addedSellIds()"
      />
    </tui-select>


    <div style="display: flex; gap: 16px">
      <button
        size="m"
        tuiIconButton
        type="button"
        iconStart="chart-no-axes-combined"
        [appearance]="expanded() ? 'secondary-destructive' : 'secondary'"
        (click)="expanded.set(!expanded())"
      >Статистика
      </button>

      <tui-loader style="width: 100%" size="m" [overlay]="true" [showLoader]="isLoading()">
        <button
          style="width: 100%"
          size="m"
          tuiButton
          appearance="primary"
          type="submit"
          [disabled]="isLoading() || !form.length"
          (click)="onSellButtonClick()"
        >
          Продать
        </button>
      </tui-loader>
    </div>
  </div>
</div>

<ng-template #chipList let-kzt let-prefix="prefix">
  <div style="display: flex; flex-direction: column; gap: 16px">
    <div style="display: flex; gap: 16px; justify-content: space-between">
      <tui-chip size="s" appearance="secondary">
        {{ prefix }}{{ (kzt / kztCurrency()) | tuiFormatNumber: { precision: 0 } | async }} RUB
      </tui-chip>
      <tui-chip size="s" appearance="primary">
        {{ prefix }}{{ kzt | tuiFormatNumber: { precision: 0 } | async }} KZT
      </tui-chip>
    </div>
  </div>
</ng-template>
